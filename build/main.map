{"version":3,"sources":["webpack:///webpack/bootstrap 536ed4653196adbcce6c","webpack:///external \"immutable\"","webpack:///external \"debug\"","webpack:///./src/index.js","webpack:///external \"redux\"","webpack:///external \"node-telegram-bot-api\"","webpack:///./src/Reducer.js","webpack:///./src/Activity.js","webpack:///./src/History.js","webpack:///./src/CacheHandler.js"],"names":["debug","constructor","token","options","cache","stores","activities","on","message","chatId","chat","id","store","initState","get","set","subscribe","state","getState","toJS","activity","action","params","reason","text","dispatch","bind","type","payload","refer","checkRedirect","setCacheHandler","handler","createActivity","name","callback","forwardChatId","merge","referer","newState","update","defaultState","Map","require","fromJS","undefined","actions","Array","isArray","args","apply","keyboards","forEach","value","key","push","length","forward","back","data","Promise","resolve"],"mappings":"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","file":"main.js","sourcesContent":[" \t// The module cache\n \tvar installedModules = {};\n\n \t// The require function\n \tfunction __webpack_require__(moduleId) {\n\n \t\t// Check if module is in cache\n \t\tif(installedModules[moduleId]) {\n \t\t\treturn installedModules[moduleId].exports;\n \t\t}\n \t\t// Create a new module (and put it into the cache)\n \t\tvar module = installedModules[moduleId] = {\n \t\t\ti: moduleId,\n \t\t\tl: false,\n \t\t\texports: {}\n \t\t};\n\n \t\t// Execute the module function\n \t\tmodules[moduleId].call(module.exports, module, module.exports, __webpack_require__);\n\n \t\t// Flag the module as loaded\n \t\tmodule.l = true;\n\n \t\t// Return the exports of the module\n \t\treturn module.exports;\n \t}\n\n\n \t// expose the modules object (__webpack_modules__)\n \t__webpack_require__.m = modules;\n\n \t// expose the module cache\n \t__webpack_require__.c = installedModules;\n\n \t// define getter function for harmony exports\n \t__webpack_require__.d = function(exports, name, getter) {\n \t\tif(!__webpack_require__.o(exports, name)) {\n \t\t\tObject.defineProperty(exports, name, {\n \t\t\t\tconfigurable: false,\n \t\t\t\tenumerable: true,\n \t\t\t\tget: getter\n \t\t\t});\n \t\t}\n \t};\n\n \t// getDefaultExport function for compatibility with non-harmony modules\n \t__webpack_require__.n = function(module) {\n \t\tvar getter = module && module.__esModule ?\n \t\t\tfunction getDefault() { return module['default']; } :\n \t\t\tfunction getModuleExports() { return module; };\n \t\t__webpack_require__.d(getter, 'a', getter);\n \t\treturn getter;\n \t};\n\n \t// Object.prototype.hasOwnProperty.call\n \t__webpack_require__.o = function(object, property) { return Object.prototype.hasOwnProperty.call(object, property); };\n\n \t// __webpack_public_path__\n \t__webpack_require__.p = \"/\";\n\n \t// Load entry module and return exports\n \treturn __webpack_require__(__webpack_require__.s = 2);\n\n\n\n// WEBPACK FOOTER //\n// webpack/bootstrap 536ed4653196adbcce6c","module.exports = require(\"immutable\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"immutable\"\n// module id = 0\n// module chunks = 0","module.exports = require(\"debug\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"debug\"\n// module id = 1\n// module chunks = 0","import {\n  createStore\n} from 'redux'\nimport Immutable from 'immutable'\nimport TelegramBot from 'node-telegram-bot-api'\nimport Debug from 'debug'\n\nimport Reducer, {defaultState} from './Reducer'\nimport Activity from './Activity'\nimport History from './History'\nimport CacheHandler from './CacheHandler'\n\nconst debug = Debug('tgux:subscriber')\n\nexport default class extends TelegramBot {\n\n  constructor(token, options = {}) {\n    super(token, options)\n\n    this.cache = new CacheHandler\n\n    this.stores = {}\n    this.activities = {}\n\n    this.on('message', async(message) => {\n\n      let chatId = message.chat.id\n      let store = this.stores[chatId]\n\n      if (!store) {\n        let initState = await this.cache.get('State' + chatId)\n\n        if (!initState) {\n          initState = defaultState.set('message', message)\n        }\n\n        store = createStore(Reducer, initState)\n\n        store.subscribe(function () {\n          let state = store.getState().toJS()\n          let {\n            activity,\n            action,\n            message,\n            params,\n            reason\n          } = state\n\n          debug({\n            activity,\n            action,\n            message: message && message.text,\n            params,\n            reason\n          })\n\n          if (message) {\n            this.cache.set('State' + message.chat.id, state)\n          }\n\n          this.activities[activity].dispatch(action, [message, new History(store, reason, params)])\n\n        }.bind(this))\n\n        this.stores[chatId] = store\n      }\n\n      if (message.text == '/start') {\n        return store.dispatch({\n          type: 'REST',\n          payload: {\n            message\n          }\n        })\n      }\n\n      let {\n        activity,\n        action,\n        params\n      } = store.getState().toJS()\n\n      if (action == 'home') {\n        let refer = this.activities[activity].checkRedirect(message.text)\n        if (refer) {\n          return store.dispatch({\n            type: 'FW',\n            payload: {\n              message,\n              refer,\n              params\n            }\n          })\n        }\n      }\n\n      store.dispatch({\n        type: 'RECV',\n        payload: {\n          message\n        }\n      })\n    })\n  }\n\n  setCacheHandler(handler) {\n    if (typeof handler == 'function') {\n      handler = new handler\n    }\n    this.cache = handler\n  }\n\n  createActivity(name, callback) {\n    this.activities[name] = new Activity(name)\n    callback(this.activities[name])\n  }\n\n  forwardChatId(chatId, refer, params = {}) {\n    let store = this.stores[chatId]\n    if (!store) {\n      return false\n    }\n    let {\n      message\n    } = store.getState().toJS()\n    return store.dispatch({\n      type: 'FW',\n      payload: {\n        message,\n        refer,\n        params\n      }\n    })\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/index.js","module.exports = require(\"redux\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"redux\"\n// module id = 4\n// module chunks = 0","module.exports = require(\"node-telegram-bot-api\");\n\n\n//////////////////\n// WEBPACK FOOTER\n// external \"node-telegram-bot-api\"\n// module id = 5\n// module chunks = 0","import Immutable from 'immutable'\n\nconst debug = require('debug')('tgux:reducer')\n\nexport const defaultState = Immutable.fromJS({\n  activity: 'start',\n  action: 'home',\n  message: undefined,\n  params: {},\n  reason: 'normal',\n  referer: {},\n})\n\nexport default function (state, {\n  type,\n  payload = {}\n}) {\n  debug(type, payload, state)\n\n  switch (type) {\n    case 'RECV':\n      {\n        let {\n          message\n        } = payload\n        return state\n          .merge({\n            message,\n            reason: 'normal'\n          })\n      }\n    case 'BACK':\n      {\n        let referer = state.get('referer')\n        return state\n          .merge(referer)\n          .merge({\n            reason: 'back',\n            referer: {}\n          })\n      }\n    case 'FW':\n      {\n        let {\n          message,\n          refer,\n          params\n        } = payload\n        let [activity, action] = refer\n        let newState = state\n          .merge({\n            message,\n            params,\n            reason: 'forward'\n          })\n          .update('referer', () => {\n            if (activity == 'start' && action == 'home') {\n              return {}\n            }\n            return {\n              activity: state.get('activity'),\n              action: state.get('action'),\n            }\n          })\n\n        if (!action) {\n          return newState.merge({\n            action: activity\n          })\n        } else {\n          return newState.merge({\n            activity,\n            action\n          })\n        }\n      }\n    case 'REST':\n      {\n        let {\n          message\n        } = payload\n        return defaultState.merge({\n          message\n        })\n      }\n    default:\n      {\n        return Immutable.Map(state)\n      }\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/Reducer.js","import Immutable from 'immutable'\n\nexport default class {\n  constructor(name) {\n    this.name = name\n    this.actions = {}\n  }\n\n  on(action, callback) {\n    this.actions[action] = callback\n  }\n\n  checkRedirect(text) {\n    let action = this.actions[text]\n    return action && Array.isArray(action) && action\n  }\n\n  dispatch(action, args) {\n    this.actions[action].apply(this, args)\n  }\n\n  get keyboards() {\n    let actions = Immutable.Map(this.actions)\n    let keyboards = []\n    actions.forEach((value, key) => {\n      if (Array.isArray(value)) {\n        keyboards.push(key)\n      }\n    })\n    if (!keyboards.length) {\n      return false\n    }\n    return [keyboards]\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/Activity.js","import Immutable from 'immutable'\nimport Debug from 'debug'\n\nconst debug = Debug('tgux:history')\n\nexport default class {\n  constructor(store, reason = 'normal', params = {}) {\n    this.store = store\n    this.reason = reason\n    this.params = params\n  }\n\n  forward(refer, params) {\n    debug('Forward', refer)\n    let {\n      message\n    } = this.store.getState().toJS()\n    this.store.dispatch({\n      type: 'FW',\n      payload: {\n        message,\n        refer,\n        params\n      }\n    })\n  }\n\n  back() {\n    debug('Back')\n    this.store.dispatch({\n      type: 'BACK'\n    })\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/History.js","import Debug from 'debug'\n\nconst debug = Debug('tgux:cache')\n\nexport default class {\n  constructor() {\n    this.data = {}\n  }\n\n  set(key, value) {\n    debug('Write', key, value)\n    return new Promise(function (resolve) {\n      this.data[key] = value\n      resolve()\n    }.bind(this))\n  }\n\n  get(key) {\n    debug('Read', key)\n    return new Promise(function (resolve) {\n      if (key in this.data) {\n        return resolve(this.data[key])\n      } else {\n        return resolve(false)\n      }\n    }.bind(this))\n  }\n}\n\n\n\n// WEBPACK FOOTER //\n// ./src/CacheHandler.js"],"sourceRoot":""}